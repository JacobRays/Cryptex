<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <title>Register - Cryptex Malawi</title>
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <meta name="color-scheme" content="dark" />
  <link rel="stylesheet" href="assets/css/theme.css">
  <style>
    :root{
      --bg-0:#0f0f10; --bg-1:#121212; --surface:#1e1e1e; --surface-2:#2c2c2c;
      --gold:#D4AF37; --gold-2:#E0C16A; --muted:#9E9E9E; --text:#f5f5f5;
      --danger:#F44336; --success:#4CAF50; --warn:#FF9800;
      --radius:14px; --shadow:0 10px 30px rgba(0,0,0,.45); --ring:0 0 0 2px rgba(212,175,55,.35);
    }
    body {
      min-height: 100vh;
      display: grid;
      place-items: center;
      padding: 1.25rem;
      color: var(--text);
      background:
        radial-gradient(60vw 60vw at 10% -10%, rgba(212,175,55,.08), transparent 60%),
        radial-gradient(70vw 70vw at 110% -20%, rgba(224,193,106,.06), transparent 60%),
        linear-gradient(135deg, var(--bg-0), var(--bg-1));
    }
    .container { width: 100%; max-width: 520px; }
    .logo-wrap{ text-align:center; margin-bottom: 1rem; }
    .logo{
      font-weight:900; letter-spacing:.18rem; font-size: clamp(2.2rem, 5vw, 3.2rem); line-height:1;
      background: linear-gradient(135deg, var(--gold), var(--gold-2) 70%);
      background-clip:text; -webkit-background-clip:text; color: transparent; -webkit-text-fill-color: transparent;
      text-transform: uppercase; transform: rotateX(14deg) rotateY(-10deg);
      text-shadow: 0 1px 0 #b38f2b, 0 2px 0 #9c7a1d, 0 12px 24px rgba(212,175,55,.25);
      display:inline-block; transition: transform .4s ease, text-shadow .4s ease;
    }
    .logo:hover{ transform: rotateX(0) rotateY(0) translateY(-2px) scale(1.02); }
    .card{ background:var(--surface); border:1px solid rgba(212,175,55,.18); border-radius:16px; box-shadow: var(--shadow); }
    .card-inner{ padding:1.5rem; }
    .title{ text-align:center; color:var(--gold-2); margin: 0 0 .25rem; }
    .subtitle{ text-align:center; color:#c9b882; font-size:.92rem; margin-bottom:1rem; }

    .field{ margin-bottom: .9rem; }
    .field label{ display:block; font-size:.9rem; color:#E0C16A; margin-bottom:.35rem; font-weight:700; }
    .input-wrap{ position:relative; }
    .input{ width:100%; }
    .toggle-eye{
      position:absolute; right:.6rem; top:50%; transform:translateY(-50%);
      background:transparent; border:none; color:#ccc; cursor:pointer; font-size:1rem;
    }
    .hint{ font-size:.8rem; color:var(--muted); margin-top:.25rem; }
    .hint.bad{ color: var(--danger); }
    .hint.good{ color: var(--success); }

    .pwd-meter{ height:8px; background:#222; border-radius:999px; overflow:hidden; margin-top:.4rem; }
    .pwd-bar{ height:100%; width:0%; background:linear-gradient(90deg, #ff5252, #ff9800, #ffc107, #8bc34a); transition: width .25s ease; }

    .terms-row{ display:flex; align-items:flex-start; gap:.55rem; margin-top:.4rem; }
    .terms-row input{ margin-top:.15rem; }
    .btn.block{ width:100%; }

    .trust-row{ display:flex; align-items:center; justify-content:center; gap:.75rem; flex-wrap:wrap; margin-top:1rem; }
    .trust-pill{ background:#1b1b1b; border:1px solid rgba(255,255,255,.08); color:#d6d6d6; padding:.35rem .6rem; border-radius:999px; font-size:.8rem; display:flex; align-items:center; gap:.4rem; }

    .stepper{ display:flex; align-items:center; justify-content:center; gap:.75rem; margin-bottom:.75rem; }
    .step{ display:flex; align-items:center; gap:.5rem; color:#c9b882; }
    .dot{ width:10px; height:10px; border-radius:50%; border:2px solid var(--gold-2); background:transparent; }
    .dot.active{ background: var(--gold-2); }
    .step-label{ font-size:.85rem; }

    /* Email verify modal */
    .modal{ display:none; position:fixed; inset:0; z-index:1000; background:rgba(0,0,0,.8); }
    .modal-content{ background:#121212; border:1px solid rgba(212,175,55,.35); border-radius:14px; max-width:520px; width:95%; margin:6% auto; box-shadow:0 0 40px rgba(212,175,55,.3); }
    .modal-head{ padding:1rem 1.25rem; border-bottom:1px solid #333; display:flex; align-items:center; justify-content:space-between; }
    .modal-title{ margin:0; color:var(--gold-2); font-weight:900; }
    .modal-body{ padding:1rem 1.25rem; }
    .close-modal{ background:#222; color:var(--gold-2); border:1px solid var(--gold-2); border-radius:8px; padding:.25rem .6rem; cursor:pointer; }

    .code-grid{ display:flex; gap:.5rem; justify-content:center; }
    .code-input{
      width:46px; height:52px; text-align:center; font-size:1.25rem; border-radius:10px;
      background:#1b1b1b; color:#fff; border:1px solid #333; outline:none;
    }
    .code-actions{ display:flex; justify-content:space-between; align-items:center; margin-top:.85rem; gap:.75rem; flex-wrap:wrap; }
    .link{ color:var(--gold-2); background:none; border:none; cursor:pointer; padding:0; text-decoration:underline; }
    .muted{ color: var(--muted); }

    /* Hidden honeypot */
    .hp{ position:absolute; left:-99999px; width:1px; height:1px; overflow:hidden; }

    /* Toast fallback */
    #toast{ position:fixed; bottom:24px; left:50%; transform:translateX(-50%); background:#1b1b1b; color:var(--gold-2); padding:.7rem 1rem; border-radius:10px; box-shadow:var(--shadow); display:none; z-index:1200; }
  </style>
</head>
<body>
  <div class="container">
    <div class="logo-wrap">
      <div class="logo">CRYPT-X</div>
    </div>

    <div class="card">
      <div class="card-inner">
        <div class="stepper" aria-hidden="true">
          <div class="step"><span class="dot active"></span><span class="step-label">Account</span></div>
          <div class="step"><span class="dot" id="stepVerifyDot"></span><span class="step-label">Verify Email</span></div>
        </div>

        <h2 class="title">Create Your Account</h2>
        <p class="subtitle">Start trading securely with KYC-ready onboarding.</p>

        <form id="regForm" novalidate>
          <!-- Honeypot -->
          <input type="text" id="hpCompany" class="hp" autocomplete="organization" tabindex="-1" aria-hidden="true">

          <div class="field">
            <label for="fullName">Full Name</label>
            <input type="text" id="fullName" class="input" placeholder="Your full name" autocomplete="name" required>
          </div>

          <div class="field">
            <label for="email">Email Address</label>
            <input type="email" id="email" class="input" placeholder="you@cryptex.mw" autocomplete="email" required>
            <div id="emailHint" class="hint"></div>
          </div>

          <div class="field">
            <label for="phone">Phone Number</label>
            <input type="tel" id="phone" class="input" placeholder="e.g., 0888123456 or +265888123456" inputmode="tel" required>
            <div id="phoneHint" class="hint"></div>
          </div>

          <div class="field">
            <label for="password">Password</label>
            <div class="input-wrap">
              <input type="password" id="password" class="input" placeholder="At least 8 characters" autocomplete="new-password" required>
              <button class="toggle-eye" type="button" aria-label="Show password" data-target="password">üëÅÔ∏è</button>
            </div>
            <div class="pwd-meter" aria-hidden="true"><div id="pwdBar" class="pwd-bar"></div></div>
            <div id="pwdHint" class="hint"></div>
          </div>

          <div class="field">
            <label for="confirmPassword">Confirm Password</label>
            <div class="input-wrap">
              <input type="password" id="confirmPassword" class="input" placeholder="Repeat your password" autocomplete="new-password" required>
              <button class="toggle-eye" type="button" aria-label="Show password" data-target="confirmPassword">üëÅÔ∏è</button>
            </div>
            <div id="matchHint" class="hint"></div>
          </div>

          <div class="field">
            <label for="refCode">Referral Code (optional)</label>
            <input type="text" id="refCode" class="input" placeholder="Enter referral code if any" autocomplete="one-time-code">
          </div>

          <div class="terms-row">
            <input type="checkbox" id="agree" required>
            <label for="agree" class="hint">I agree to the <a href="legal/terms.html" target="_blank">Terms</a> and <a href="legal/privacy.html" target="_blank">Privacy Policy</a>.</label>
          </div>

          <div class="field" style="margin-top:.85rem;">
            <button class="btn block" id="btnRegister" type="submit" disabled>Create Account</button>
          </div>
          <div class="field">
            <button class="btn block ghost" type="button" onclick="location.href='index.html'">Already have an account? Login</button>
          </div>
        </form>

        <div class="trust-row" aria-hidden="true">
          <div class="trust-pill">üîí 256-bit encryption</div>
          <div class="trust-pill">ü™™ KYC & AML-ready</div>
          <div class="trust-pill">üõ°Ô∏è Fraud checks</div>
        </div>
      </div>
    </div>
  </div>

  <!-- Verify Email Modal -->
  <div id="verifyModal" class="modal" role="dialog" aria-modal="true" aria-labelledby="verifyTitle">
    <div class="modal-content">
      <div class="modal-head">
        <h3 id="verifyTitle" class="modal-title">Verify your email</h3>
        <button class="close-modal" type="button" onclick="closeVerifyModal()">√ó</button>
      </div>
      <div class="modal-body">
        <p class="muted">We sent a 6‚Äëdigit code to <strong id="verifyEmailEcho"></strong>. Enter it below to verify your account.</p>
        <div class="code-grid" style="margin:.8rem 0;">
          <input class="code-input" inputmode="numeric" maxlength="1">
          <input class="code-input" inputmode="numeric" maxlength="1">
          <input class="code-input" inputmode="numeric" maxlength="1">
          <input class="code-input" inputmode="numeric" maxlength="1">
          <input class="code-input" inputmode="numeric" maxlength="1">
          <input class="code-input" inputmode="numeric" maxlength="1">
        </div>
        <div class="code-actions">
          <span id="resendInfo" class="muted">You can resend in 30s</span>
          <button id="btnResend" class="link" type="button" disabled>Resend code</button>
        </div>
        <div style="margin-top:1rem; display:flex; gap:.6rem; justify-content:flex-end; flex-wrap:wrap;">
          <button class="btn ghost" type="button" onclick="closeVerifyModal()">Cancel</button>
          <button class="btn" id="btnVerify" type="button">Verify</button>
        </div>
      </div>
    </div>
  </div>

  <div id="toast">Saved</div>

  <script src="assets/js/core.js"></script>
  <script>
    (function(){
      'use strict';

      // ===== Fallback Core (if not loaded) =====
      if(!window.Core){
        window.Core = {
          toast: (msg)=>{ const t=document.getElementById('toast'); if(!t){ alert(msg); return; } t.textContent=msg; t.style.display='block'; clearTimeout(Core._t); Core._t=setTimeout(()=>t.style.display='none', 2000); },
          safeParse: (s, d)=>{ try{ return JSON.parse(s) }catch(e){ return d } }
        };
      }
      const toast = Core.toast;

      // ===== Broadcast bus =====
      const bus = ('BroadcastChannel' in window) ? new BroadcastChannel('cryptex') : null;

      // ===== Helpers =====
      const $ = sel => document.querySelector(sel);
      const $$ = sel => Array.from(document.querySelectorAll(sel));
      const emailRe = /^[^\s@]+@[^\s@]+\.[^\s@]+$/i;

      function normalizeMWPhone(input){
        const digits = String(input||'').replace(/\D/g,'');
        let p = digits;
        if (p.startsWith('265')) p = p.slice(3);
        if (p.startsWith('0')) p = p.slice(1);
        // Malawi mobiles commonly 9 digits after 0 / country code
        if (p.length !== 9) return null;
        return '+265' + p;
      }

      function calcPwdStrength(pwd){
        let score = 0;
        if(pwd.length >= 8) score++;
        if(pwd.length >= 12) score++;
        if(/[a-z]/.test(pwd)) score++;
        if(/[A-Z]/.test(pwd)) score++;
        if(/\d/.test(pwd)) score++;
        if(/[^A-Za-z0-9]/.test(pwd)) score++;
        return Math.min(score, 6);
      }

      async function hashPassword(password, salt){
        try{
          const enc = new TextEncoder();
          const data = enc.encode(salt + ':' + password);
          const hash = await crypto.subtle.digest('SHA-256', data);
          const b = new Uint8Array(hash);
          return btoa(String.fromCharCode(...b));
        }catch(e){
          // Fallback (non-crypto environments)
          return btoa(password + '|' + salt);
        }
      }
      function genSalt(len=16){
        const arr = new Uint8Array(len); (crypto.getRandomValues ? crypto.getRandomValues(arr) : arr).forEach((v,i)=>arr[i]=Math.floor(Math.random()*256));
        return btoa(String.fromCharCode(...arr));
      }
      function genUserId(){
        return 'U-' + (Date.now().toString(36) + Math.random().toString(36).slice(2,7)).toUpperCase();
      }
      function genCode(len=6){
        let s=''; for(let i=0;i<len;i++) s += Math.floor(Math.random()*10);
        return s;
      }

      // ===== Elements =====
      const form = $('#regForm');
      const fullName = $('#fullName');
      const email = $('#email');
      const phone = $('#phone');
      const password = $('#password');
      const confirmPassword = $('#confirmPassword');
      const agree = $('#agree');
      const refCode = $('#refCode');
      const btnRegister = $('#btnRegister');
      const emailHint = $('#emailHint');
      const phoneHint = $('#phoneHint');
      const pwdBar = $('#pwdBar');
      const pwdHint = $('#pwdHint');
      const matchHint = $('#matchHint');

      // Prefill referral and email from URL if present
      const params = new URLSearchParams(location.search);
      if(params.get('ref')) refCode.value = params.get('ref');
      if(params.get('email')) email.value = params.get('email');

      // ===== Live validation =====
      function updateRegisterState(){
        const okName = fullName.value.trim().length >= 2;
        const okEmail = emailRe.test(email.value.trim());
        const normPhone = normalizeMWPhone(phone.value);
        const okPhone = !!normPhone;
        const pwd = password.value;
        const str = calcPwdStrength(pwd);
        const okPwd = pwd.length >= 8 && str >= 3;
        const okMatch = pwd && pwd === confirmPassword.value;
        const okAgree = agree.checked;

        // hints
        emailHint.textContent = okEmail ? '' : (email.value ? 'Please enter a valid email' : '');
        emailHint.className = 'hint' + (okEmail ? '' : ' bad');

        if(phone.value){
          phoneHint.textContent = okPhone ? `Will be saved as ${normPhone}` : 'Enter a valid Malawi number (e.g., 0888123456 or +265888123456)';
          phoneHint.className = 'hint ' + (okPhone ? 'good' : 'bad');
        }else{
          phoneHint.textContent = '';
          phoneHint.className = 'hint';
        }

        const pct = Math.min(100, str/6*100);
        pwdBar.style.width = pct + '%';
        let label = '';
        if(pwd.length){
          label = str <= 2 ? 'Weak' : (str <= 4 ? 'Good' : 'Strong');
          pwdHint.textContent = `Password strength: ${label}`;
          pwdHint.className = 'hint ' + (str <= 2 ? 'bad' : 'good');
        }else{
          pwdHint.textContent = '';
          pwdHint.className = 'hint';
        }

        if(confirmPassword.value){
          matchHint.textContent = okMatch ? 'Passwords match' : 'Passwords do not match';
          matchHint.className = 'hint ' + (okMatch ? 'good' : 'bad');
        }else{
          matchHint.textContent = '';
          matchHint.className = 'hint';
        }

        btnRegister.disabled = !(okName && okEmail && okPhone && okPwd && okMatch && okAgree);
      }

      ['input','change','blur','keyup'].forEach(ev=>{
        [fullName,email,phone,password,confirmPassword,agree,refCode].forEach(el=>{
          el.addEventListener(ev, updateRegisterState);
        });
      });

      // Caps Lock hint for password
      [password, confirmPassword].forEach(el=>{
        el.addEventListener('keydown', e=>{
          if(e.getModifierState && e.getModifierState('CapsLock')){
            pwdHint.textContent = 'Caps Lock is ON';
            pwdHint.className = 'hint bad';
          }
        });
      });

      // Show/hide password toggles
      $$('.toggle-eye').forEach(btn=>{
        btn.addEventListener('click', ()=>{
          const id = btn.getAttribute('data-target');
          const input = document.getElementById(id);
          if(!input) return;
          input.type = input.type === 'password' ? 'text' : 'password';
          btn.textContent = input.type === 'password' ? 'üëÅÔ∏è' : 'üôà';
          input.focus();
        });
      });

      // ===== Email Verify Modal logic =====
      const verifyModal = $('#verifyModal');
      const verifyEmailEcho = $('#verifyEmailEcho');
      const stepVerifyDot = $('#stepVerifyDot');
      const btnResend = $('#btnResend');
      const resendInfo = $('#resendInfo');
      const btnVerify = $('#btnVerify');
      const codeInputs = $$('.code-input');

      let currentEmail = '';
      let resendTimer = 30; let resendInterval = null;

      function openVerifyModal(targetEmail){
        currentEmail = targetEmail;
        verifyEmailEcho.textContent = currentEmail;
        // clear codes
        codeInputs.forEach(i=>{ i.value=''; i.classList.remove('bad'); });
        codeInputs[0].focus();

        // timer
        resendTimer = 30;
        resendInfo.textContent = 'You can resend in 30s';
        btnResend.disabled = true;
        clearInterval(resendInterval);
        resendInterval = setInterval(()=>{
          resendTimer--;
          if(resendTimer<=0){
            clearInterval(resendInterval);
            resendInfo.textContent = 'Didn‚Äôt get the code?';
            btnResend.disabled = false;
          }else{
            resendInfo.textContent = `You can resend in ${resendTimer}s`;
          }
        },1000);

        stepVerifyDot.classList.add('active');
        verifyModal.style.display = 'block';
      }
      window.closeVerifyModal = function(){
        verifyModal.style.display = 'none';
        stepVerifyDot.classList.remove('active');
      }

      // Auto-advance and paste support
      codeInputs.forEach((input, idx)=>{
        input.addEventListener('input', (e)=>{
          const v = e.target.value.replace(/\D/g,'').slice(0,1);
          e.target.value = v;
          if(v && idx < codeInputs.length-1) codeInputs[idx+1].focus();
        });
        input.addEventListener('keydown', (e)=>{
          if(e.key === 'Backspace' && !e.target.value && idx>0) codeInputs[idx-1].focus();
        });
        input.addEventListener('paste', (e)=>{
          const text = (e.clipboardData || window.clipboardData).getData('text').replace(/\D/g,'').slice(0,6);
          if(text.length){
            e.preventDefault();
            codeInputs.forEach((i, j)=> i.value = text[j] || '');
            const last = Math.min(text.length, codeInputs.length) - 1;
            codeInputs[Math.max(0,last)].focus();
          }
        });
      });

      btnResend.addEventListener('click', ()=>{
        if(btnResend.disabled) return;
        const codes = Core.safeParse(localStorage.getItem('platform.emailCodes'), {});
        const code = genCode(6);
        codes[currentEmail] = { code, expiresAt: Date.now() + (10*60*1000), attempts: 0 };
        localStorage.setItem('platform.emailCodes', JSON.stringify(codes));
        toast('Verification code resent');
        openVerifyModal(currentEmail);
      });

      btnVerify.addEventListener('click', ()=>{
        const inputCode = codeInputs.map(i=>i.value).join('');
        if(inputCode.length !== 6){ codeInputs.forEach(i=>i.classList.add('bad')); return toast('Enter the 6‚Äëdigit code'); }
        const codes = Core.safeParse(localStorage.getItem('platform.emailCodes'), {});
        const entry = codes[currentEmail];
        if(!entry){ return toast('No verification request found'); }
        if(Date.now() > +entry.expiresAt){ return toast('Code expired. Please resend a new code.'); }
        if(inputCode !== entry.code){
          entry.attempts = (entry.attempts||0) + 1;
          codes[currentEmail] = entry;
          localStorage.setItem('platform.emailCodes', JSON.stringify(codes));
          codeInputs.forEach(i=>{ i.classList.add('bad'); setTimeout(()=>i.classList.remove('bad'), 600); });
          return toast('Invalid code. Please try again.');
        }
        // success
        closeVerifyModal();
        finalizeLogin(currentEmail, true);
      });

      // ===== Registration submit =====
      form.addEventListener('submit', async (e)=>{
        e.preventDefault();
        if($('#hpCompany').value){ return; } // bot trap
        if(btnRegister.disabled) return;

        const name = fullName.value.trim();
        const mail = email.value.trim().toLowerCase();
        const normPhone = normalizeMWPhone(phone.value);
        const pwd = password.value;
        const conf = confirmPassword.value;
        const ref = refCode.value.trim();

        if(!name || !emailRe.test(mail) || !normPhone || pwd.length<8 || pwd!==conf || !agree.checked){
          return toast('Please correct the highlighted fields');
        }

        btnRegister.disabled = true;
        btnRegister.textContent = 'Creating account...';

        // Uniqueness
        let users = Core.safeParse(localStorage.getItem('platform.users'), []);
        if (users.some(u => (u.email||'').toLowerCase() === mail)){
          btnRegister.disabled = false; btnRegister.textContent = 'Create Account';
          return toast('An account with this email already exists');
        }
        if (users.some(u => (u.phone||'') === normPhone)){
          btnRegister.disabled = false; btnRegister.textContent = 'Create Account';
          return toast('An account with this phone already exists');
        }

        // Hash password
        const salt = genSalt();
        const hash = await hashPassword(pwd, salt);

        // Create user
        const user = {
          id: genUserId(),
          email: mail,
          name,
          phone: normPhone,
          role: 'user',
          emailVerified: false,
          kycStatus: 'pending',
          banned: false,
          referrer: ref || params.get('ref') || '',
          createdAt: new Date().toISOString()
        };
        users.unshift(user);
        localStorage.setItem('platform.users', JSON.stringify(users));

        // Store credentials separately
        const creds = Core.safeParse(localStorage.getItem('platform.credentials'), {});
        creds[mail] = { hash, salt, passwordUpdatedAt: new Date().toISOString() };
        localStorage.setItem('platform.credentials', JSON.stringify(creds));

        // Create verification code
        const codes = Core.safeParse(localStorage.getItem('platform.emailCodes'), {});
        const code = genCode(6);
        codes[mail] = { code, expiresAt: Date.now() + (10*60*1000), attempts: 0 };
        localStorage.setItem('platform.emailCodes', JSON.stringify(codes));

        // Move to verify step
        toast('Account created. Please verify your email.');
        $('#stepVerifyDot').classList.add('active');
        openVerifyModal(mail);
        btnRegister.disabled = false;
        btnRegister.textContent = 'Create Account';
      });

      // ===== Finalize login =====
      function finalizeLogin(mail, verifiedNow=false){
        const users = Core.safeParse(localStorage.getItem('platform.users'), []);
        const idx = users.findIndex(u => (u.email||'').toLowerCase() === mail);
        if(idx>-1){
          users[idx].emailVerified = verifiedNow ? true : (users[idx].emailVerified || false);
          localStorage.setItem('platform.users', JSON.stringify(users));
        }
        const me = users[idx];

        // Session keys used by other pages
        localStorage.setItem('user', mail);
        localStorage.setItem('role', me?.role || 'user');
        localStorage.setItem('userName', me?.name || '');
        localStorage.setItem('userPhone', me?.phone || '');
        localStorage.setItem('emailVerified', String(me?.emailVerified || false));
        localStorage.setItem('kycStatus', me?.kycStatus || 'pending');

        // Reset wallet/transactions for new session to avoid carry-over
        localStorage.removeItem('transactions');
        localStorage.setItem('wallet', JSON.stringify({ usdt: 0, mwk: 0 }));

        // Broadcast auth login to other tabs/pages
        if(bus) bus.postMessage({ type:'auth.login', payload:{ email: mail, at: Date.now() } });

        // Go to dashboard
        setTimeout(()=> window.location.href = 'dashboard.html', 300);
      }

      // Allow closing modal on ESC
      window.addEventListener('keydown', e=>{ if(e.key==='Escape') closeVerifyModal(); });

      // Init state
      updateRegisterState();
    })();
  </script>
</body>
</html>